<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Playground</title>
        <link rel="stylesheet" href="css/app.css">
    </head>
    <body>

        <div id="layer-gl"></div>
        <div id="layer-nodes"></div>

        <div id="logo"></div>

        <div id="bottom-bar">
            <div class="button" id="category-0">
                <div class="title">
                    All
                </div>
                <div class="subtitle">
                    Lorem ipsum dolor sit amet
                </div>
            </div>
            <div class="button" id="category-1">
                <div class="title">
                    Category 1
                </div>
                <div class="subtitle">
                    Lorem ipsum dolor sit amet
                </div>
            </div>
            <div class="button" id="category-2">
                <div class="title">
                    Category 2
                </div>
                <div class="subtitle">
                    Lorem ipsum dolor sit amet
                </div>
            </div>
            <div class="button" id="category-3">
                <div class="title">
                    Category 3
                </div>
                <div class="subtitle">
                    Lorem ipsum dolor sit amet
                </div>
            </div>
            <div class="button" id="category-4">
                <div class="title">
                    Category 4
                </div>
                <div class="subtitle">
                    Lorem ipsum dolor sit amet
                </div>
            </div>
            <div class="button" id="category-5">
                <div class="title">
                    Category 5
                </div>
                <div class="subtitle">
                    Lorem ipsum dolor sit amet
                </div>
            </div>
        </div>

        <!-- <p id="title">PARTICLE CLUSTER EDITOR</p> -->

        <script src="lib/jquery-1.12.0.min.js"></script>
        <script src="lib/dat.gui.min.js"></script>
		<script src="lib/three.min.js"></script>
        <script src="lib/Stats.js"></script>
        <script src="lib/dat.gui.min.js"></script>

        <script src="src/App.js"></script>
        <script src="src/Particle.js"></script>
        <script src="src/Constraint.js"></script>
        <script src="src/Spring.js"></script>
        <script src="src/SpringMinDist.js"></script>
        <script src="src/Attraction.js"></script>
        <script src="src/Physics.js"></script>
        <script src="src/Noise.js"></script>
        <script src="src/Walker2.js"></script>
        <script src="src/Cluster.js"></script>


        <script type="x-shader/x-vertex" id="vertexshader">

			attribute float size;
			attribute vec3 customColor;
            attribute float imageFlag;

            varying vec3 vColor;
            varying float vImgIndex;

			void main() {

				vColor = customColor;
                vImgIndex = imageFlag;

				vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );

				gl_PointSize = size * 2.0;

				gl_Position = projectionMatrix * mvPosition;

			}

		</script>


		<script type="x-shader/x-fragment" id="fragmentshader">

			uniform sampler2D texture;
            uniform sampler2D texture2;
            uniform sampler2D texture3;

			varying vec3 vColor;
            varying float vImgIndex;

			void main() {

                vec4 texColor = ( vImgIndex == 0.0 ) ? texture2D( texture, gl_PointCoord ) :
                                ( vImgIndex == 1.0 ) ? texture2D( texture2, gl_PointCoord ) :
                                texture2D( texture3, gl_PointCoord );

				gl_FragColor = vec4( vColor, 0.8 );
				gl_FragColor = gl_FragColor * texColor;

			}

		</script>


        <script>

            // render 3D
            var scene, camera, renderer,
                sprite, sprite2,
                materialPoints, materialLines;

            // render DOM
            var nodes = [];

            // physics model
            var physics,
                clusters = [],
                mouseParticle,
                clusterParticles = 50,

                clusterPositions; // TODO: create data object

            var sceneWidth, sceneHeight,

                backgroundColor,

                //stats,
                gui;


            // TODO:
            // states
            var currentState; // state_ClustersAll, state_ClusterFilter, state_NodeView, state_VideoView

            var activeCluster, activeNode; // TODO: move to state

            //TODO: use states to avoid flags
            var useMouseInteraction = true;


            init();
            animate();


            function init() {

                var $holder = $('#layer-gl');

                sceneWidth = $holder.width();
                sceneHeight = $holder.height();

                backgroundColor = new THREE.Color( 0xF2F3F4 );

                scene = new THREE.Scene();

                camera = new THREE.OrthographicCamera( sceneWidth / -2, sceneWidth / 2, sceneHeight / 2, sceneHeight / -2, 1, 1000 );
                camera.position.z = 500;

                renderer = new THREE.WebGLRenderer( { antialias: true } );
                renderer.setPixelRatio( window.devicePixelRatio );
                renderer.setSize( sceneWidth, sceneHeight );
                renderer.setClearColor( backgroundColor.getHex() );

		        $holder.append( $(renderer.domElement) );

                //buildGui();

                initMaterials();
                initPhysics();
                buildClusters();

                document.addEventListener( 'mousemove', onDocumentMouseMove, false );
                window.addEventListener( 'resize', onWindowResize, false );

                onWindowResize();

            }


            function animate() {

                requestAnimationFrame( animate );

                //stats.begin();

                physics.update();

                // clusters
                for ( var i = 0; i < clusters.length; i++ ) {
                    clusters[ i ].update();
                }

                updateMouseInteraction();

                // nodes

                // var projScreenMat = new THREE.Matrix4();
                // projScreenMat.multiplyMatrices( camera.projectionMatrix, camera.matrixWorldInverse );

                for ( var i = 0; i < nodes.length; i++ ) {
                    var $node = nodes[ i ],
                        particle = $node.data("particle"),
                        screenPos = particle.pos.clone();

                        // transform
                        screenPos.x = sceneWidth - (screenPos.x + sceneWidth/2);
        				screenPos.y = sceneHeight/2 - screenPos.y;
                        // screenPos.applyMatrix4( projScreenMat );	           // NDC (-1.0..1.0)
        				// screenPos.x = ( - screenPos.x + 1 ) * sceneWidth/2;    // viewport transform
        		        // screenPos.y = ( - screenPos.y + 1 ) * sceneHeight/2;


                    $node.css({
                        right : screenPos.x,
                        top : screenPos.y
                    });

                }

                renderer.render( scene, camera );

                //stats.end();

            }


            function initPhysics() {

                mouseParticle = new APP.Particle(0, 0, 0);
                mouseParticle.isFixed = true;

                physics = new APP.Physics();
                physics.gravity.z = APP.parameters.gravity;

            }


            function initMaterials() {

                var uniforms = {
            		texture:  { type: "t", value: new THREE.TextureLoader().load( "assets/circle-fill.png" ) },
            		texture2: { type: "t", value: new THREE.TextureLoader().load( "assets/circle-line.png" ) },
                    texture3: { type: "t", value: new THREE.TextureLoader().load( "assets/circle-marked.png" ) }
            	};

                materialPoints = new THREE.ShaderMaterial( {
    				uniforms: uniforms,
    				vertexShader: document.getElementById( 'vertexshader' ).textContent,
    				fragmentShader: document.getElementById( 'fragmentshader' ).textContent,

    				// blending:        THREE.AdditiveBlending,
    				depthTest:       false,
    				transparent:     true,
                    alphaTest:       0.5
    			});

                materialLines = new THREE.LineBasicMaterial( { color: 0xdddddd, linewidth: 1, transparent: true, opacity: 0.2, depthTest: false } );
                materialLines.visible = false;

            }


            function buildClusters() {

                for (var i = 0; i < APP.data.length; i++) {
                    var clusterData = APP.data[ i ];
                    var pos = clusterData.position.clone();
                    pos.x *= sceneWidth/2;
                    pos.y *= sceneHeight/2;
                    var numParticles = 20 + Math.random() * 10; // number of background particles

                    var cluster = new APP.Cluster( mouseParticle, materialPoints, materialLines );
                    cluster.setup( clusterData, numParticles, pos );
                    cluster.addToPhysics( physics );
                    cluster.addToScene( scene );

                    clusters.push( cluster );
                }

                // interactive nodes

                var $layer = $('#layer-nodes'),
                    i, j,
                    clusterData,
                    cluster,
                    particles,
                    node,
                    size,
                    clusterColor = new THREE.Color();

                for ( i = 0; i < APP.data.length; i++ ) {
                    clusterData = APP.data[ i ],
                    cluster = clusters[ i ],

                    particles = cluster.interactiveParticles;

                    clusterColor.setHex( clusterData.color );

                    for ( j = 0; j < particles.length; j++ ) {
                        particle = particles[ j ];

                        size = particle.data.size;

                        $node = $( APP.templates.nodeTemplate );
                        $node.data( 'particle', particle );
                        $node.find('.circle').css({
                            'background-color' : '#' + clusterColor.getHexString(),
                            'width': size,
                            'height': size
                        });

                        nodes.push( $node );

                        $layer.append( $node );
                    }
                }

                // buttons
                var $bottomBar = $( '#bottom-bar' ),
                    r, g, b, a,
                    rgba;

                for ( i = 0; i < APP.data.length; i++ ) {
                    clusterData = APP.data[ i ];
                    cluster = clusters[ i ];
                    clusterColor.setHex( clusterData.color );

                    r = clusterColor.r * 255;
                    g = clusterColor.g * 255;
                    b = clusterColor.b * 255;
                    a = 0.5;
                    rgba = 'rgba(' + r + ',' + g + ',' + b + ',' + a + ')';

                    $bottomBar
                        .find( '#' + clusterData.slug )
                        .css( 'border-top-color', '#' + clusterColor.getHexString() )
                        .data( 'cluster', cluster )
                        .data( 'color', rgba )
                }

                clusterColor.setHex( '#777777' );
                r = clusterColor.r * 255;
                g = clusterColor.g * 255;
                b = clusterColor.b * 255;
                a = 0.5;
                rgba = 'rgba(' + r + ',' + g + ',' + b + ',' + a + ')';

                $bottomBar
                    .find( '#category-0' )
                    .css( 'border-top-color', '#777777' )
                    .data( 'color', rgba );


                $bottomBar
                    .on( 'click', '.button', function() {
                        $bottomBar.find('.active')
                            .removeClass( 'active' )
                            .css( 'background-color', '' );

                        $( this )
                            .addClass( 'active' )
                            .css( 'background-color', $( this ).data( 'color' ) );

                        selectCluster( $( this ).data( 'cluster' ) );
                    })
                    .on( 'mouseenter', '.button', function() {
                        $( this ).css( 'background-color', $( this ).data( 'color' ) );
                    })
                    .on( 'mouseleave', '.button', function() {
                        if ( !$( this ).hasClass( 'active' ) ){
                            $( this ).css( 'background-color', '' );
                        }
                    });

                // TODO: fix
                var $all = $bottomBar.find( '#category-0' )
                $all
                    .addClass( 'active' )
                    .css( 'background-color', $all.data( 'color' ) );
            }


            function selectCluster( newCluster ) {

                // filter off

                if ( newCluster === undefined ){

                    physics.gravity.z = APP.parameters.gravity;

                    for ( var i = 0; i < clusters.length; i++ ) {
                        setClusterState( clusters[ i ], APP.clusterStates.default );
                    }

                    activeCluster = newCluster;

                    useMouseInteraction = true;

                    return; // stop here
                }

                // filter on

                if ( newCluster === activeCluster ) {
                    return;
                }

                // test
                physics.gravity.z = 3.21;

                for ( var i = 0; i < clusters.length; i++ ) {
                    var cluster = clusters[i];
                    if ( cluster === newCluster ) {
                        setClusterState( cluster, APP.clusterStates.opened );

                    } else {
                        setClusterState( cluster, APP.clusterStates.closed );
                    }
                }

                activeCluster = newCluster;

                useMouseInteraction = false;

            }


            function setClusterState( cluster, state ) {

                cluster.setClusterRadius( state['cluster_radius'] );
                cluster.setSurfaceStrength( state['surface_strength'] );
                cluster.setCentralAttraction( state['central_attraction'] );
                cluster.setMouseAttraction( state['mouse_attraction'] );
                cluster.setSpringStrengthInteractive( state['spring_strength_interactive'] );
                cluster.setSpringLengthInteractive( state['spring_length_interactive'] );
                cluster.setAttractionStrengthInteractive( state['attraction_strength_interactive'] );

            }


            function onDocumentMouseMove( event ) {

				mouseParticle.pos.x = event.clientX - sceneWidth/2;
				mouseParticle.pos.y = sceneHeight/2 - event.clientY;

			}


            function onWindowResize( event ) {

                var $holder = $('#layer-gl');

                sceneWidth = $holder.width();
                sceneHeight = $holder.height();

                camera.left = sceneWidth / -2;
                camera.right = sceneWidth / 2;
                camera.top = sceneHeight / 2;
                camera.bottom = sceneHeight / -2;
                camera.updateProjectionMatrix();

                for (var i = 0; i < APP.data.length; i++) {
                    var clusterData = APP.data[ i ];
                    var pos = clusterData.position.clone();
                    pos.y += 0.1;
                    pos.x *= sceneWidth/2;
                    pos.y *= sceneHeight/2;

                    clusters[ i ].setPosition( pos );
                }

                renderer.setSize( sceneWidth, sceneHeight );

            }


            function updateMouseInteraction() {

                for ( var i = 0; i < clusters.length; i++ ) {
                    var cluster = clusters[ i ];

                    var delta = new THREE.Vector3();
                        delta.subVectors( mouseParticle.pos, cluster.centralParticle.pos );

                    var distance = delta.length(),
                        numMouseAttractions = cluster.mouseAttractions.length,
                        enabled = (distance < cluster.limitDistance) ? true : false;

                    // enable / disable mouse attractions
                    for ( var j = 0; j < numMouseAttractions; j++ ) {
                        cluster.mouseAttractions[ j ].enabled = enabled;
                    }

                    if ( useMouseInteraction ) {
                        // strength of attraction relative to mouse distance to center
                        distance = (distance < cluster.limitDistance) ? distance : cluster.limitDistance;
                        var attractionStrength = (distance / cluster.limitDistance) * 100;

                        cluster.setCentralAttraction( attractionStrength );
                    }
                }

            }


            // gui -----------------------------------


            function buildGui() {

                // stats = new Stats();
				// stats.domElement.style.position = 'absolute';
				// stats.domElement.style.top = '0px';
                // document.body.appendChild( stats.domElement );

                gui = new dat.GUI( { width: 350 } );

                gui.remember( APP.parameters );

                gui.add( APP.parameters, 'cluster_radius', 10.0, 250.0 ).onChange( onClusterRadius );
                gui.add( APP.parameters, 'surface_strength', 0.0, 0.05 ).onChange( onSurfaceStrength );
                gui.add( APP.parameters, 'central_attraction', -1000.0, 1000.0 ).onChange( onCentralRepulsion );
                gui.add( APP.parameters, 'mouse_attraction', -500.0, 500.0 ).onChange( onMouseAttraction );

                gui.add( APP.parameters, 'spring_strength_interactive', 0.0, 0.5 ).onChange( onSpringStrengthInteractive );
                gui.add( APP.parameters, 'spring_length_interactive', 0.0, 200.0 ).onChange( onSpringLengthInteractive );
                gui.add( APP.parameters, 'attraction_strength_interactive', -1000.0, 1000.0 ).onChange( onAttractionStrengthInteractive );

                gui.add( APP.parameters, 'gravity', 0.0, 10.0 ).onChange( onGravity );
                gui.add( APP.parameters, 'background_darkness', 0.0, 1.0 ).onChange( onBackgroundDarkness );

                // callbacks

                function onClusterRadius( value ) {

                    for ( var i = 0; i < clusters.length; i++ ) {
                        clusters[ i ].setClusterRadius( value );
                    }

                }

                function onSurfaceStrength( value ) {

                    for ( var i = 0; i < clusters.length; i++ ) {
                        clusters[ i ].setSurfaceStrength( value );
                    }

                }

                function onCentralRepulsion( value ) {

                    for ( var i = 0; i < clusters.length; i++ ) {
                        clusters[ i ].setCentralAttraction( value );
                    }

                }

                function onMouseAttraction( value ) {

                    for ( var i = 0; i < clusters.length; i++ ) {
                        clusters[ i ].setMouseAttraction( value );
                    }

                }

                function onSpringStrengthInteractive( value ) {

                    for ( var i = 0; i < clusters.length; i++ ) {
                        clusters[ i ].setSpringStrengthInteractive( value );
                    }

                }

                function onSpringLengthInteractive( value ) {

                    for ( var i = 0; i < clusters.length; i++ ) {
                        clusters[ i ].setSpringLengthInteractive( value );
                    }

                }

                function onAttractionStrengthInteractive( value ) {

                    for ( var i = 0; i < clusters.length; i++ ) {
                        clusters[ i ].setAttractionStrengthInteractive( value );
                    }

                }

                function onGravity( value ) {

                    physics.gravity.z = value;

                }

                function onBackgroundDarkness( value ) {

                    var color = new THREE.Color( 0xF2F3F4 ).lerp ( new THREE.Color( 0.12,0.11,0.15 ), value )
                    renderer.setClearColor( color.getHex() );

                }


            }

        </script>

    </body>
</html>
