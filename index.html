<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Playground</title>
        <link rel="stylesheet" href="css/app.css">
    </head>
    <body>

        <div id="layer-gl"></div>
        <div id="layer-nodes"></div>

        <div id="logo"></div>

        <div id="bottom-bar">
            <div class="button" id="category-0">
                <div class="title">
                    All
                </div>
                <div class="subtitle">
                    Lorem ipsum dolor sit amet
                </div>
            </div>
            <div class="button" id="category-1">
                <div class="title">
                    Category 1
                </div>
                <div class="subtitle">
                    Lorem ipsum dolor sit amet
                </div>
            </div>
            <div class="button" id="category-2">
                <div class="title">
                    Category 2
                </div>
                <div class="subtitle">
                    Lorem ipsum dolor sit amet
                </div>
            </div>
            <div class="button" id="category-3">
                <div class="title">
                    Category 3
                </div>
                <div class="subtitle">
                    Lorem ipsum dolor sit amet
                </div>
            </div>
            <div class="button" id="category-4">
                <div class="title">
                    Category 4
                </div>
                <div class="subtitle">
                    Lorem ipsum dolor sit amet
                </div>
            </div>
            <div class="button" id="category-5">
                <div class="title">
                    Category 5
                </div>
                <div class="subtitle">
                    Lorem ipsum dolor sit amet
                </div>
            </div>
        </div>

        <!-- <p id="title">PARTICLE CLUSTER EDITOR</p> -->

        <script src="lib/jquery-1.12.0.min.js"></script>
        <script src="lib/dat.gui.min.js"></script>
		<script src="lib/three.min.js"></script>
        <script src="lib/dat.gui.min.js"></script>

        <script src="src/App.js"></script>
        <script src="src/Particle.js"></script>
        <script src="src/Constraint.js"></script>
        <script src="src/Spring.js"></script>
        <script src="src/SpringMinDist.js"></script>
        <script src="src/Attraction.js"></script>
        <script src="src/Physics.js"></script>
        <script src="src/Walker2.js"></script>
        <script src="src/Cluster.js"></script>
        <script src="src/StateDefault.js"></script>


        <script type="x-shader/x-vertex" id="vertexshader">

			attribute float size;
			attribute vec3 customColor;
            attribute float imageFlag;

            varying vec3 vColor;
            varying float vImgIndex;

			void main() {

				vColor = customColor;
                vImgIndex = imageFlag;

				vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );

				gl_PointSize = size * 2.0;

				gl_Position = projectionMatrix * mvPosition;

			}

		</script>


		<script type="x-shader/x-fragment" id="fragmentshader">

			uniform sampler2D texture;
            uniform sampler2D texture2;
            uniform sampler2D texture3;

			varying vec3 vColor;
            varying float vImgIndex;

			void main() {

                vec4 texColor = ( vImgIndex == 0.0 ) ? texture2D( texture, gl_PointCoord ) :
                                ( vImgIndex == 1.0 ) ? texture2D( texture2, gl_PointCoord ) :
                                texture2D( texture3, gl_PointCoord );

				gl_FragColor = vec4( vColor, 0.8 );
				gl_FragColor = gl_FragColor * texColor;

			}

		</script>


        <script>

            var sceneWidth, sceneHeight,
                backgroundColor;

            // render 3D
            var scene, camera, renderer,
                materialPoints, materialLines;

            // physics model
            var physics,
                clusters = [],
                mouseParticle;

            // dom
            var $bottomBar = $( '#bottom-bar' );

            // TODO:
            // states
            var currentState; // state_ClustersAll, state_ClusterFilter, state_NodeView, state_VideoView
            var categoryIndex, nodeIndex;
            var useMouseInteraction = true;

            var gui;


            init();
            animate();


            function init() {

                var $holder = $('#layer-gl');

                sceneWidth = $holder.width();
                sceneHeight = $holder.height();

                backgroundColor = new THREE.Color( 0xF2F3F4 );

                scene = new THREE.Scene();

                camera = new THREE.OrthographicCamera( sceneWidth / -2, sceneWidth / 2, sceneHeight / 2, sceneHeight / -2, 1, 1000 );
                camera.position.z = 500;

                renderer = new THREE.WebGLRenderer( { antialias: true } );
                renderer.setPixelRatio( window.devicePixelRatio );
                renderer.setSize( sceneWidth, sceneHeight );
                renderer.setClearColor( backgroundColor.getHex() );

		        $holder.append( $(renderer.domElement) );

                //buildGui();

                initMaterials();
                initPhysics();
                buildClusters( APP.data );
                buildBar( APP.data );

                document.addEventListener( 'mousemove', onDocumentMouseMove, false );
                window.addEventListener( 'resize', onWindowResize, false );

                onWindowResize();

                setState( new APP.StateDefault( this, -1 ) );

            }


            function setState( newState ) {

                if ( currentState ) {
                    currentState.exit();
                }

                currentState = newState;
                currentState.enter();

            }


            function animate() {

                requestAnimationFrame( animate );

                currentState.update();

                renderer.render( scene, camera );

            }


            function initPhysics() {

                mouseParticle = new APP.Particle(0, 0, 0);
                mouseParticle.isFixed = true;

                physics = new APP.Physics();
                physics.gravity.z = APP.parameters.gravity;

            }


            function initMaterials() {

                var uniforms = {
            		texture:  { type: "t", value: new THREE.TextureLoader().load( "assets/circle-fill.png" ) },
            		texture2: { type: "t", value: new THREE.TextureLoader().load( "assets/circle-line.png" ) },
                    texture3: { type: "t", value: new THREE.TextureLoader().load( "assets/circle-marked.png" ) }
            	};

                materialPoints = new THREE.ShaderMaterial( {
    				uniforms: uniforms,
    				vertexShader: document.getElementById( 'vertexshader' ).textContent,
    				fragmentShader: document.getElementById( 'fragmentshader' ).textContent,

    				// blending:        THREE.AdditiveBlending,
    				depthTest:       false,
    				transparent:     true,
                    alphaTest:       0.5
    			});

                materialLines = new THREE.LineBasicMaterial( { color: 0xdddddd, linewidth: 1, transparent: true, opacity: 0.2, depthTest: false } );
                materialLines.visible = false;

            }


            function buildClusters( data ) {

                for (var i = 0; i < data.length; i++) {
                    var clusterData = data[ i ];
                    var pos = clusterData.position.clone();
                    pos.x *= sceneWidth/2;
                    pos.y *= sceneHeight/2;
                    var numParticles = 20 + Math.random() * 10; // number of background particles

                    var cluster = new APP.Cluster( mouseParticle, materialPoints, materialLines );
                    cluster.setup( i, clusterData, numParticles, pos );
                    cluster.addToPhysics( physics );
                    cluster.addToScene( scene );
                    cluster.addToDom( $('#layer-nodes') );

                    clusters.push( cluster );
                }

            }


            function buildBar( data ){

                var clusterColor = new THREE.Color(),
                    clusterColorString;

                for ( i = 0; i < data.length; i++ ) {
                    clusterData = data[ i ];
                    cluster = clusters[ i ];

                    clusterColor.setHex( clusterData.color );
                    clusterColorString = getColorString( clusterColor, 0.5 );

                    $bottomBar.find( '#' + clusterData.slug )
                        .css( 'border-top-color', '#' + clusterColor.getHexString() )
                        .data( 'categoryIndex', i )
                        .data( 'color', clusterColorString );
                }

                clusterColor.setHex( 0x777777 );
                clusterColorString = getColorString( clusterColor, 0.5 );

                $bottomBar.find( '#category-0' )
                    .css( 'border-top-color', '#777777' )
                    .data( 'categoryIndex', -1 )
                    .data( 'color', clusterColorString );

                function getColorString( color, alpha ) {
                    var c = color.clone(),
                        r = c.r * 255,
                        g = c.g * 255,
                        b = c.b * 255,
                        a = alpha;
                    return 'rgba(' + r + ',' + g + ',' + b + ',' + a + ')';
                }

            }


            function onDocumentMouseMove( event ) {

				mouseParticle.pos.x = event.clientX - sceneWidth/2;
				mouseParticle.pos.y = sceneHeight/2 - event.clientY;

			}


            function onWindowResize( event ) {

                var $holder = $('#layer-gl');

                sceneWidth = $holder.width();
                sceneHeight = $holder.height();

                camera.left = sceneWidth / -2;
                camera.right = sceneWidth / 2;
                camera.top = sceneHeight / 2;
                camera.bottom = sceneHeight / -2;
                camera.updateProjectionMatrix();

                for (var i = 0; i < APP.data.length; i++) {
                    var clusterData = APP.data[ i ];
                    var pos = clusterData.position.clone();
                    pos.y += 0.1;
                    pos.x *= sceneWidth/2;
                    pos.y *= sceneHeight/2;

                    clusters[ i ].setPosition( pos );
                }

                renderer.setSize( sceneWidth, sceneHeight );

            }


            // gui -----------------------------------


            function buildGui() {

                // stats = new Stats();
				// stats.domElement.style.position = 'absolute';
				// stats.domElement.style.top = '0px';
                // document.body.appendChild( stats.domElement );

                gui = new dat.GUI( { width: 350 } );

                gui.remember( APP.parameters );

                gui.add( APP.parameters, 'cluster_radius', 10.0, 250.0 ).onChange( onClusterRadius );
                gui.add( APP.parameters, 'surface_strength', 0.0, 0.05 ).onChange( onSurfaceStrength );
                gui.add( APP.parameters, 'central_attraction', -1000.0, 1000.0 ).onChange( onCentralRepulsion );
                gui.add( APP.parameters, 'mouse_attraction', -500.0, 500.0 ).onChange( onMouseAttraction );

                gui.add( APP.parameters, 'spring_strength_interactive', 0.0, 0.5 ).onChange( onSpringStrengthInteractive );
                gui.add( APP.parameters, 'spring_length_interactive', 0.0, 200.0 ).onChange( onSpringLengthInteractive );
                gui.add( APP.parameters, 'attraction_strength_interactive', -1000.0, 1000.0 ).onChange( onAttractionStrengthInteractive );

                gui.add( APP.parameters, 'gravity', 0.0, 10.0 ).onChange( onGravity );
                gui.add( APP.parameters, 'background_darkness', 0.0, 1.0 ).onChange( onBackgroundDarkness );

                // callbacks

                function onClusterRadius( value ) {

                    for ( var i = 0; i < clusters.length; i++ ) {
                        clusters[ i ].setClusterRadius( value );
                    }

                }

                function onSurfaceStrength( value ) {

                    for ( var i = 0; i < clusters.length; i++ ) {
                        clusters[ i ].setSurfaceStrength( value );
                    }

                }

                function onCentralRepulsion( value ) {

                    for ( var i = 0; i < clusters.length; i++ ) {
                        clusters[ i ].setCentralAttraction( value );
                    }

                }

                function onMouseAttraction( value ) {

                    for ( var i = 0; i < clusters.length; i++ ) {
                        clusters[ i ].setMouseAttraction( value );
                    }

                }

                function onSpringStrengthInteractive( value ) {

                    for ( var i = 0; i < clusters.length; i++ ) {
                        clusters[ i ].setSpringStrengthInteractive( value );
                    }

                }

                function onSpringLengthInteractive( value ) {

                    for ( var i = 0; i < clusters.length; i++ ) {
                        clusters[ i ].setSpringLengthInteractive( value );
                    }

                }

                function onAttractionStrengthInteractive( value ) {

                    for ( var i = 0; i < clusters.length; i++ ) {
                        clusters[ i ].setAttractionStrengthInteractive( value );
                    }

                }

                function onGravity( value ) {

                    physics.gravity.z = value;

                }

                function onBackgroundDarkness( value ) {

                    var color = new THREE.Color( 0xF2F3F4 ).lerp ( new THREE.Color( 0.12,0.11,0.15 ), value )
                    renderer.setClearColor( color.getHex() );

                }

            }


        </script>

    </body>
</html>
